@page
@model GAM106_ASM.Pages.Quests.IndexModel
@{
    ViewData["Title"] = "Quản lý Nhiệm vụ";
}

<div class="page-header">
    <div class="header-content">
        <h1><i class="fas fa-scroll"></i> Quản lý Nhiệm vụ</h1>
        <p>Quản lý tất cả nhiệm vụ trong game</p>
    </div>
    <button class="btn btn-primary" onclick="openCreateModal()">
        <i class="fas fa-plus"></i> Thêm nhiệm vụ
    </button>
</div>

<!-- Search -->
<div class="filter-section">
    <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Tìm kiếm nhiệm vụ..." onkeyup="filterTable()">
    </div>
</div>

<!-- Quests Table -->
<div class="table-container">
    <table class="data-table" id="questsTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Tên nhiệm vụ</th>
                <th>Mô tả</th>
                <th>Điểm thưởng</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var quest in Model.Quests)
            {
                <tr>
                    <td>@quest.QuestId</td>
                    <td>@quest.QuestName</td>
                    <td>@quest.Description</td>
                    <td><span class="badge badge-green">@quest.ExperienceReward EXP</span></td>
                    <td class="action-btns">
                        <button class="btn-icon btn-edit" onclick="openEditModal(@quest.QuestId)" title="Sửa">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-delete" onclick="openDeleteModal(@quest.QuestId, '@quest.QuestName')"
                            title="Xóa">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Create/Edit Modal -->
<div id="questModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Thêm nhiệm vụ mới</h2>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <form id="questForm" onsubmit="return handleSubmit(event)">
            <input type="hidden" id="questId" name="QuestId">

            <div class="form-group">
                <label for="questName">Tên nhiệm vụ <span class="required">*</span></label>
                <input type="text" id="questName" name="QuestName" required>
            </div>

            <div class="form-group">
                <label for="description">Mô tả</label>
                <textarea id="description" name="Description" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label for="experienceReward">Điểm thưởng (EXP)</label>
                <input type="number" id="experienceReward" name="ExperienceReward" value="0" min="0">
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Hủy</button>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i class="fas fa-save"></i> Lưu
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h2>Xác nhận xóa</h2>
            <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="delete-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Bạn có chắc chắn muốn xóa nhiệm vụ <strong id="deleteQuestName"></strong>?</p>
                <p class="warning-text">Hành động này không thể hoàn tác!</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Hủy</button>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                <i class="fas fa-trash"></i> Xóa
            </button>
        </div>
    </div>
</div>

<script>
    let currentDeleteId = null;

    function openCreateModal() {
        document.getElementById('modalTitle').textContent = 'Thêm nhiệm vụ mới';
        document.getElementById('questForm').reset();
        document.getElementById('questId').value = '';
        document.getElementById('questModal').classList.add('active');
    }

    async function openEditModal(id) {
        try {
            const response = await fetch(`/api/Admin/Quests/${id}`);
            const quest = await response.json();

            document.getElementById('modalTitle').textContent = 'Chỉnh sửa nhiệm vụ';
            document.getElementById('questId').value = quest.questId;
            document.getElementById('questName').value = quest.questName;
            document.getElementById('description').value = quest.description || '';
            document.getElementById('experienceReward').value = quest.experienceReward;

            document.getElementById('questModal').classList.add('active');
        } catch (error) {
            alert('Lỗi khi tải thông tin: ' + error.message);
        }
    }

    function closeModal() {
        document.getElementById('questModal').classList.remove('active');
    }

    async function handleSubmit(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const questId = formData.get('QuestId');
        const data = {
            questId: questId ? parseInt(questId) : 0,
            questName: formData.get('QuestName'),
            description: formData.get('Description'),
            experienceReward: parseInt(formData.get('ExperienceReward'))
        };

        try {
            const url = questId ? `/api/Admin/Quests/${questId}` : '/api/Admin/Quests';
            const method = questId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok || response.status === 204) {
                closeModal();
                location.reload();
            } else {
                const error = await response.text();
                alert('Lỗi: ' + error);
            }
        } catch (error) {
            alert('Lỗi khi lưu: ' + error.message);
        }

        return false;
    }

    function openDeleteModal(id, name) {
        currentDeleteId = id;
        document.getElementById('deleteQuestName').textContent = name;
        document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.remove('active');
        currentDeleteId = null;
    }

    async function confirmDelete() {
        if (!currentDeleteId) return;

        try {
            await fetch(`/api/Admin/Quests/${currentDeleteId}`, {
                method: 'DELETE'
            });
            closeDeleteModal();
            location.reload();
        } catch (error) {
            alert('Lỗi: ' + error.message);
        }
    }

    function filterTable() {
        const searchValue = document.getElementById('searchInput').value.toLowerCase();
        const table = document.getElementById('questsTable');
        const rows = table.getElementsByTagName('tr');

        for (let i = 1; i < rows.length; i++) {
            const name = rows[i].getElementsByTagName('td')[1].textContent.toLowerCase();
            const desc = rows[i].getElementsByTagName('td')[2].textContent.toLowerCase();
            rows[i].style.display = (name.includes(searchValue) || desc.includes(searchValue)) ? '' : 'none';
        }
    }
</script>

<link rel="stylesheet" href="~/css/crud-page.css" asp-append-version="true" />